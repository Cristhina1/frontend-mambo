<div class="container-fluid p-4" style="background: #f9fafb; min-height: 100vh;">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 style="color: #111827; font-weight: 700;">
        <i class="bi bi-receipt me-3"></i>Generar Boleta
      </h1>
    </div>
    <button class="btn btn-light border" (click)="limpiarFormulario()">
      <i class="bi bi-arrow-clockwise me-2"></i>Nueva Venta
    </button>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">

        <div class="card-header border-0 bg-white p-4">
          <button class="btn w-100 d-flex align-items-center justify-content-center p-3"
                  (click)="abrirModal()"
                  style="background: #111827; color: white; border-radius: 10px; font-size: 1.1rem;">
            <i class="bi bi-search me-2"></i> BUSCAR Y AGREGAR PRODUCTOS
          </button>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead style="background: #f9fafb;">
                <tr>
                  <th class="ps-4">Producto</th>
                  <th class="text-center">Precio</th>
                  <th class="text-center">Cantidad</th>
                  <th class="text-end">Subtotal</th>
                  <th class="text-center pe-4">Acción</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of productos; let i = index">
                  <td class="ps-4">
                    <div class="fw-bold text-dark">{{ item.nombre }}</div>
                    <small class="text-muted">{{ item.codigo }}</small>
                  </td>
                  <td class="text-center">S/ {{ item.precio | number:'1.2-2' }}</td>

                  <td class="text-center">
                    <div class="d-flex align-items-center justify-content-center gap-2">
                      <button class="btn btn-sm btn-outline-secondary" (click)="disminuirCantidad(i)" [disabled]="item.cantidad <= 1">
                        <i class="bi bi-dash"></i>
                      </button>
                      <span class="fw-bold" style="width: 30px;">{{ item.cantidad }}</span>
                      <button class="btn btn-sm btn-outline-dark" (click)="incrementarCantidad(i)" [disabled]="item.cantidad >= item.stockMaximo">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </td>

                  <td class="text-end fw-bold text-dark">S/ {{ (item.cantidad * item.precio) | number:'1.2-2' }}</td>

                  <td class="text-center pe-4">
                    <button class="btn btn-sm text-danger" (click)="eliminarProducto(i)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>

                <tr *ngIf="productos.length === 0">
                  <td colspan="5" class="text-center py-5 text-muted">
                    <i class="bi bi-cart x2 mb-2" style="font-size: 2rem;"></i>
                    <p>El carrito está vacío. Agregue productos.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm" style="border-radius: 12px;">
        <div class="card-body p-4">
            <h5 class="mb-3 fw-bold">Datos del Cliente</h5>
            <div class="mb-3">
              <input class="form-control" [(ngModel)]="boleta.nombreCliente" placeholder="Nombre Cliente">
              <input type="text" class="form-control"
           [(ngModel)]="boleta.numDocumento"
           placeholder="Nro Documento">
                <input type="email" class="form-control" [(ngModel)]="boleta.email" placeholder="ejemplo@correo.com">
                <input type="text" class="form-control"
           [(ngModel)]="boleta.metodoPago"
           placeholder="Escribe: EFECTIVO, TARJETA o YAPE">
    <small class="text-muted" style="font-size: 0.8rem;">
       Opciones válidas: Efectivo, Tarjeta, Yape
    </small>
            </div>

            <hr>

            <div class="d-flex justify-content-between mb-2">
                <span>Subtotal</span>
                <span>S/ {{ subtotal | number:'1.2-2' }}</span>
            </div>
            <div class="d-flex justify-content-between mb-3">
                <span>IGV (18%)</span>
                <span>S/ {{ igv | number:'1.2-2' }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded mb-3">
                <span class="fw-bold fs-5">TOTAL</span>
                <span class="fw-bold fs-4 text-primary">S/ {{ total | number:'1.2-2' }}</span>
            </div>

            <button class="btn btn-success w-100 py-2 fw-bold" (click)="generarBoleta()">
                <i class="bi bi-check-circle me-2"></i> CONFIRMAR VENTA
            </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" *ngIf="modalAbierto"></div>
<div class="custom-modal" *ngIf="modalAbierto">
  <div class="modal-content-wrapper">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold m-0">Seleccionar Producto</h5>
        <button class="btn-close" (click)="cerrarModal()"></button>
    </div>

    <div class="mb-3">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0 ps-0"
                   [(ngModel)]="buscarRapido"
                   placeholder="Buscar por nombre o código..." autofocus>
        </div>
    </div>

    <div class="product-list-container">
        <table class="table table-hover">
            <thead class="table-light sticky-top">
                <tr>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let p of disponibles | filterProducto:buscarRapido"
                    (click)="seleccionarProducto(p)"
                    style="cursor: pointer;">
                    <td><small>{{ p.codigo }}</small></td>
                    <td>{{ p.nombre }}</td>
                    <td class="fw-bold">S/ {{ p.precio }}</td>
                    <td>
                        <span class="badge"
                              [ngClass]="{'bg-success': p.stock > 5, 'bg-warning': p.stock <= 5, 'bg-danger': p.stock === 0}">
                            {{ p.stock }}
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-primary rounded-circle" [disabled]="p.stock === 0">
                            <i class="bi bi-plus"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <div *ngIf="(disponibles | filterProducto:buscarRapido).length === 0" class="text-center p-4">
            <p class="text-muted">No se encontraron productos.</p>
        </div>
    </div>

  </div>
</div>

<style>
/* Fondo oscuro */
.modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 1040;
}

/* Contenedor del Modal Centrado */
.custom-modal {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90%; max-width: 700px;
    background: white;
    z-index: 1050;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    animation: slideDown 0.3s ease;
}

.modal-content-wrapper {
    padding: 20px;
}

/* Área scrollable para la lista */
.product-list-container {
    max-height: 400px; /* Altura máxima de la lista */
    overflow-y: auto;
    border: 1px solid #f1f5f9;
    border-radius: 8px;
}

/* Sticky Header para la tabla del modal */
.sticky-top { position: sticky; top: 0; z-index: 2; }

@keyframes slideDown {
    from { transform: translate(-50%, -60%); opacity: 0; }
    to { transform: translate(-50%, -50%); opacity: 1; }
}
</style>

<!-- Estilos CSS -->
<style>
/* Efectos hover */
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Efectos para productos disponibles */
.d-flex[style*="cursor: pointer"]:hover {
  background: #f9fafb !important;
  border-color: #111827 !important;
  transform: translateY(-2px);
}

/* Scrollbar personalizado */
div[style*="overflow-y: auto"]::-webkit-scrollbar {
  width: 6px;
}

div[style*="overflow-y: auto"]::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 3px;
}

/* Focus states */
.form-control:focus, .form-select:focus {
  border-color: #111827 !important;
  box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1) !important;
}

/* Responsive */
@media (max-width: 992px) {
  .col-lg-8, .col-lg-4 {
    width: 100%;
  }

  .d-flex.gap-3 {
    flex-wrap: wrap;
    gap: 10px !important;
  }

  .btn {
    flex: 1;
    min-width: 200px;
  }
}

/* Animaciones */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.card {
  animation: fadeIn 0.3s ease;
}
</style>
